//@version=5
indicator("Livermore strategy v1.0", overlay=true)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š Livermore Strategy v1.0 - åˆ©å¼—è«å°”äº¤æ˜“ç­–ç•¥
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 
// ã€æ ¸å¿ƒæŒ‡æ ‡ã€‘
//   â€¢ GMMAï¼ˆé¡¾æ¯”å¤åˆç§»åŠ¨å¹³å‡çº¿ï¼‰- çŸ­æœŸç»„/é•¿æœŸç»„äº¤å‰
//   â€¢ SuperTrendï¼ˆè¶…çº§è¶‹åŠ¿ï¼‰- è¶‹åŠ¿æ–¹å‘ç¡®è®¤
// 
// ã€äº¤æ˜“ä¿¡å·ã€‘
//   ä¹°å…¥ï¼šGMMAé‡‘å‰ + SuperTrendä¸Šå‡
//   å–å‡ºï¼šGMMAæ­»å‰ + SuperTrendä¸‹é™
// 
// ã€å¯è§†åŒ–åŠŸèƒ½ã€‘
//   âœ“ ä¿¡å·è‡ªåŠ¨ç¼–å·ï¼ˆåŒå‘é€’å¢ï¼Œåå‘é‡ç½®ï¼‰
//   âœ“ åŒå‘ç›ˆäºè¿½è¸ªï¼ˆåšå¤š/åšç©ºï¼‰
//   âœ“ åŠ¨æ€æ ‡ç­¾å®šä½ï¼ˆåŸºäºATRï¼‰
//   âœ“ è™šçº¿æŒ‡å‘Kçº¿
//   âœ“ ç›ˆäºè¿çº¿ï¼ˆç»¿=ç›ˆåˆ©ï¼Œçº¢=äºæŸï¼‰
// 
// ã€é€‚ç”¨åœºæ™¯ã€‘è¶‹åŠ¿å¸‚åœº | ä¸­é•¿çº¿äº¤æ˜“ | M1/M5å‘¨æœŸ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ===== GMMA è®¡ç®— =====
// çŸ­æœŸGMMA
ema3  = ta.ema(close, 3)
ema5  = ta.ema(close, 5)
ema8  = ta.ema(close, 8)
ema10 = ta.ema(close, 10)
ema12 = ta.ema(close, 12)
ema15 = ta.ema(close, 15)
shortAvg = (ema3 + ema5 + ema8 + ema10 + ema12 + ema15) / 6

// é•¿æœŸGMMA
ema30 = ta.ema(close, 30)
ema35 = ta.ema(close, 35)
ema40 = ta.ema(close, 40)
ema45 = ta.ema(close, 45)
ema50 = ta.ema(close, 50)
ema60 = ta.ema(close, 60)
longAvg = (ema30 + ema35 + ema40 + ema45 + ema50 + ema60) / 6

// GMMA ä¸Šç©¿æ¡ä»¶
gmmaCrossUp = ta.crossover(shortAvg, longAvg)
gmmaPrevCondition = (shortAvg[1] <= longAvg[1]) or (shortAvg[2] <= longAvg[2])
gmmaSignal = gmmaCrossUp and gmmaPrevCondition

// ===== SuperTrend è®¡ç®— =====
atrPeriod = input.int(10, "ATR å‘¨æœŸ", minval=1)
factor = input.float(3.0, "SuperTrend å› å­", minval=0.01, step=0.01)

[supertrend, direction] = ta.supertrend(factor, atrPeriod)

// SuperTrend æ¡ä»¶
priceAboveSupertrend = close > supertrend
supertrendRising = direction < 0  // direction < 0 è¡¨ç¤ºä¸Šå‡è¶‹åŠ¿
// æ–¹æ¡ˆ1ï¼šç§»é™¤ä¸Šä¸€æ ¹Kçº¿çš„é™åˆ¶ï¼Œåªè¦ä»·æ ¼åœ¨SuperTrendçº¿ä¸Šæ–¹ä¸”è¶‹åŠ¿å‘ä¸Šå³å¯
supertrendSignal = priceAboveSupertrend and supertrendRising


// ===== MACD è®¡ç®— =====
fastLength = input.int(12, "MACD å¿«çº¿", minval=1)
slowLength = input.int(26, "MACD æ…¢çº¿", minval=1)
signalLength = input.int(9, "MACD ä¿¡å·çº¿", minval=1)

[macdLine, signalLine, histLine] = ta.macd(close, fastLength, slowLength, signalLength)

// MACD æ¡ä»¶
difCrossUp = ta.crossover(macdLine, signalLine)  // DIF ä¸Šç©¿ DEA
macdHistPositive = histLine > 0  // MACD æŸ±çŠ¶å›¾ä¸ºæ­£
// prevDifBelowDea = macdLine[1] <= signalLine[1]  // ä¸Šä¸€å‘¨æœŸ DIF å°äºç­‰äº DEA
macdSignal = difCrossUp and macdHistPositive

// ===== ç»¼åˆä¹°å…¥ä¿¡å· =====
// buySignal = gmmaSignal and supertrendSignal and macdSignal
buySignal = gmmaSignal and supertrendSignal
// ===== å–å‡ºä¿¡å·æ¡ä»¶ =====
// GMMA ä¸‹ç©¿æ¡ä»¶
gmmaCrossDown = ta.crossunder(shortAvg, longAvg)
gmmaPrevConditionSell = shortAvg[1] >= longAvg[1]
gmmaSellSignal = gmmaCrossDown and gmmaPrevConditionSell

// SuperTrend å–å‡ºæ¡ä»¶
priceBelowSupertrend = close < supertrend
supertrendFalling = direction > 0  // direction > 0 è¡¨ç¤ºä¸‹é™è¶‹åŠ¿
// prevPriceAboveSupertrend = close[1] >= supertrend[1]
supertrendSellSignal = priceBelowSupertrend and supertrendFalling 

// MACD å–å‡ºæ¡ä»¶
difCrossDown = ta.crossunder(macdLine, signalLine)  // DIF ä¸‹ç©¿ DEA
macdHistNegative = histLine < 0  // MACD æŸ±çŠ¶å›¾ä¸ºè´Ÿ
// prevDifAboveDea = macdLine[1] >= signalLine[1]  // ä¸Šä¸€å‘¨æœŸ DIF å¤§äºç­‰äº DEA
macdSellSignal = difCrossDown and macdHistNegative

// ===== ç»¼åˆå–å‡ºä¿¡å· =====
// sellSignal = gmmaSellSignal and supertrendSellSignal and macdSellSignal
sellSignal = gmmaSellSignal  and supertrendSellSignal
// ===== å¯è§†åŒ– =====

// SuperTrend çº¿
// plot(supertrend, title="SuperTrend", color=direction < 0 ? color.green : color.red, linewidth=2)


// å…¶ä»–GMMAå‡çº¿ï¼ˆå¯é€‰ï¼Œæ³¨é‡Šæ‰å¯ä»¥å‡å°‘è§†è§‰å¹²æ‰°ï¼‰
// plot(ema3,  color=color.new(color.blue, 80), linewidth=1, title="EMA 3")
// plot(ema5,  color=color.new(color.blue, 80), linewidth=1, title="EMA 5")
// plot(ema8,  color=color.new(color.blue, 80), linewidth=1, title="EMA 8")
// plot(ema10, color=color.new(color.blue, 80), linewidth=1, title="EMA 10")
// plot(ema12, color=color.new(color.blue, 80), linewidth=1, title="EMA 12")
// plot(ema15, color=color.new(color.blue, 80), linewidth=1, title="EMA 15")
// plot(ema30, color=color.new(color.red, 80), linewidth=1, title="EMA 30")
// plot(ema35, color=color.new(color.red, 80), linewidth=1, title="EMA 35")
// plot(ema40, color=color.new(color.red, 80), linewidth=1, title="EMA 40")
// plot(ema45, color=color.new(color.red, 80), linewidth=1, title="EMA 45")
// plot(ema50, color=color.new(color.red, 80), linewidth=1, title="EMA 50")
// plot(ema60, color=color.new(color.red, 80), linewidth=1, title="EMA 60")

// è®°å½•ä¸Šä¸€æ¬¡ä¹°å…¥ä»·å’Œbar
var float lastBuyPrice = na
var int lastBuyBar = na
// è®°å½•ä¸Šä¸€æ¬¡å–å‡ºä»·å’Œbar
var float lastSellPrice = na
var int lastSellBar = na
var line tradeLine = na

// ä¿¡å·ç¼–å·ç³»ç»Ÿ
var string lastSignalType = ""  // "BUY" æˆ– "SELL"
var int signalNumber = 0        // å½“å‰ä¿¡å·ç¼–å·

if buySignal
    // ä¿¡å·ç¼–å·é€»è¾‘ï¼šå¦‚æœä¸Šä¸€ä¸ªä¿¡å·æ˜¯BUYï¼Œç¼–å·é€’å¢ï¼›å¦åˆ™é‡ç½®ä¸º1
    if lastSignalType == "BUY"
        signalNumber := signalNumber + 1
    else
        signalNumber := 1
    lastSignalType := "BUY"
    
    // ä½¿ç”¨ ATR çš„ 1.5 å€ä½œä¸ºåç§»é‡ï¼Œè®©æ ‡ç­¾å¾€ä¸‹ç§»
    atrValue = ta.atr(atrPeriod)
    labelOffset = atrValue * 1.5 + 50
    
    // å¦‚æœä¹‹å‰æœ‰å–å‡ºï¼Œç”»ä»å–åˆ°ä¹°çš„è¿çº¿ï¼Œå¹¶æ˜¾ç¤ºç›ˆäº
    buyText = "BUY #" + str.tostring(signalNumber) + "\n" + str.tostring(close, "#.##")
    if not na(lastSellPrice)
        pointDiff = lastSellPrice - close  // åšç©ºç›ˆäºï¼šå–ä»· - ä¹°ä»·
        tradeLine := line.new(x1=lastSellBar, y1=lastSellPrice, x2=bar_index, y2=close, color=pointDiff >= 0 ? color.green : color.red, width=2)
        buyText := buyText + "\nÎ”: " + str.tostring(pointDiff, "#.##")
        lastSellPrice := na
        lastSellBar := na
    
    lastBuyPrice := close
    lastBuyBar := bar_index
    
    label.new(bar_index, low - labelOffset, text=buyText, style=label.style_label_up, color=color.green, textcolor=color.white, size=size.small)
    // æ·»åŠ ä»æ ‡ç­¾åˆ°Kçº¿çš„ç®­å¤´æŒ‡å‘çº¿ï¼ˆè™šçº¿æ•ˆæœï¼‰
    line.new(bar_index, low - labelOffset, bar_index, low, color=color.new(color.green, 50), width=2, style=line.style_dotted)


if sellSignal
    // ä¿¡å·ç¼–å·é€»è¾‘ï¼šå¦‚æœä¸Šä¸€ä¸ªä¿¡å·æ˜¯SELLï¼Œç¼–å·é€’å¢ï¼›å¦åˆ™é‡ç½®ä¸º1
    if lastSignalType == "SELL"
        signalNumber := signalNumber + 1
    else
        signalNumber := 1
    lastSignalType := "SELL"
    
    // ä½¿ç”¨ ATR çš„ 1.5 å€ä½œä¸ºåç§»é‡ï¼Œè®©æ ‡ç­¾å¾€ä¸Šç§»
    atrValue = ta.atr(atrPeriod)
    labelOffset = atrValue * 1.5 + 50
    
    // å¦‚æœä¹‹å‰æœ‰ä¹°å…¥ï¼Œç”»ä»ä¹°åˆ°å–çš„è¿çº¿ï¼Œå¹¶æ˜¾ç¤ºç›ˆäº
    sellText = "SELL #" + str.tostring(signalNumber) + "\n" + str.tostring(close, "#.##")
    if not na(lastBuyPrice)
        pointDiff = close - lastBuyPrice  // åšå¤šç›ˆäºï¼šå–ä»· - ä¹°ä»·
        tradeLine := line.new(x1=lastBuyBar, y1=lastBuyPrice, x2=bar_index, y2=close, color=pointDiff >= 0 ? color.green : color.red, width=2)
        sellText := sellText + "\nÎ”: " + str.tostring(pointDiff, "#.##")
        lastBuyPrice := na
        lastBuyBar := na
    
    // è®°å½•å–å‡ºä»·æ ¼å’Œbarï¼ˆç”¨äºä¸‹æ¬¡ä¹°å…¥æ—¶ç”»è¿çº¿ï¼‰
    lastSellPrice := close
    lastSellBar := bar_index
    
    label.new(bar_index, high + labelOffset, text=sellText, style=label.style_label_down, color=color.red, textcolor=color.white, size=size.normal)
    // æ·»åŠ ä»æ ‡ç­¾åˆ°Kçº¿çš„ç®­å¤´æŒ‡å‘çº¿ï¼ˆè™šçº¿æ•ˆæœï¼‰
    line.new(bar_index, high + labelOffset, bar_index, high, color=color.new(color.red, 50), width=2, style=line.style_dotted)